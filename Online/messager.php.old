<?
//  以時間 作為判斷此使用者是否在線上的依據
//  每分鐘此php會reload一次, 此時會將超過一分半未回應的使用者消掉
//  檔案格式為   $user_id, date("U") ,$course_id
//  會使用到session中的$time.

	$RELEATED_PATH = "../";
	require_once($RELEATED_PATH . "config.php");
	require_once($RELEATED_PATH . "session.php");
    require_once($RELEATED_PATH . "library/date.php");
    require_once($HOME_PATH . 'library/filter.php') ;
	//update_states("即時訊息");
	//開啟session
	//ssession_start();	
	//new smarty
        
	$template = $_SESSION['template_path'] . $_SESSION['template'];
	$tpl_path = "../themes/" . $_SESSION['template'];				
	$tpl = new Smarty();

	if($_GET['action'] == "send"){
		$tpl->assign("HAVE","//");
		$tpl->assign("CLOSE","//");	
		$tpl->assign("receiver_pid", reguired_param($_GET[receiver],PARAM_INT));
		$tpl->assign("receiver_name", '發送給: '. required_param($_GET['receiver_name'],PARAM_CLEAN);
		
	}
	else if($_GET['action'] == "doSend"){
		$tpl->assign("HAVE","//");
		$tpl->assign("CLOSE","");
				
		$sql = "INSERT INTO transaction 
				(send, receive, message, time) 
				VALUES 
				('". $_SESSION['personal_id'] ."','".required_param($_POST['receiver_pid'],PARAM_INT) ."','". required_param($_POST['message'],PARAM_CLEAN) ."','". get_now_time_str() ."')";
		$res = $DB_CONN->query($sql);		
	}
	else if($_GET['action'] == "receive"){
		$tpl->assign("HAVE","");
		$tpl->assign("CLOSE","//");
		//查出訊息
		$sql = "SELECT * FROM transaction WHERE receive='".$_SESSION['personal_id']."'";
		$res = $DB_CONN->query($sql);
		$row = $res->fetchRow(DB_FETCHMODE_ASSOC);
		//查出login_id
		//modify by rja, 應該是要查出 personal name 才對
		$sql = "SELECT personal_name FROM personal_basic WHERE personal_id='".$row['send']."'";
		//echo $sql;
		$sender_login_name = $DB_CONN->getOne($sql);
		
		$tpl->assign("receiver_pid",$row[send]);
		$tpl->assign("receiver_name","</b>從<b>". $sender_login_name ."</b>送訊息給你: <br/>" .$row[message] . "<br/>發送時間(".$row['time'].")");
					 
		//刪除訊息
		$sql = "DELETE FROM transaction WHERE online_trans='". $row[online_trans]."'";
		$res = $DB_CONN->query($sql);		 			
	}
	else{
		$tpl->assign("HAVE","//");
		$tpl->assign("CLOSE","//");	
	}

  	$tpl->assign("tpl_path", $tpl_path);
	$tpl->display($template . "/online/messager.tpl");
				
	
//----------------function area ------------------

?>
